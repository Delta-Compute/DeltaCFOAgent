<!-- Load i18n system -->
<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>

<!-- Pattern Notifications System -->
<script src="{{ url_for('static', filename='js/pattern_notifications.js') }}"></script>

<!-- Unified Navigation Bar Component -->
<nav class="top-nav">
    <div class="nav-brand">
        <h2 data-i18n="app.title">Delta CFO Agent</h2>
        <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;" data-i18n="app.tagline">Delta's proprietary self improving AI CFO Agent</p>
    </div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Navigation Links -->
    <div class="nav-links" id="navLinks">
        <a href="/" class="nav-link {% if request.path == '/' %}active{% endif %}" data-i18n="nav.home">Home</a>
        <a href="/dashboard" class="nav-link {% if request.path == '/dashboard' %}active{% endif %}" data-i18n="nav.dashboard" data-capability="transactions">Transaction Manager</a>
        <a href="/revenue" class="nav-link {% if request.path == '/revenue' %}active{% endif %}" data-i18n="nav.revenue" data-capability="analytics">Revenue Recognition</a>
        <a href="/reports" class="nav-link {% if request.path == '/reports' %}active{% endif %}" data-i18n="nav.reports" data-capability="reports">Reports</a>
        <a href="/invoices" class="nav-link {% if request.path == '/invoices' %}active{% endif %}" data-i18n="nav.invoices" data-capability="invoices">Invoices</a>
        <a href="/workforce" class="nav-link {% if request.path == '/workforce' %}active{% endif %}" data-i18n="nav.workforce" data-capability="workforce">Workforce</a>
        <a href="/month-end-close" class="nav-link {% if request.path == '/month-end-close' %}active{% endif %}" data-i18n="nav.monthEndClose">Month-End Close</a>
        <a href="/files" class="nav-link {% if request.path == '/files' %}active{% endif %}" data-i18n="nav.files">File Manager</a>
        <a href="/tenant-knowledge" class="nav-link {% if request.path == '/tenant-knowledge' %}active{% endif %}" data-i18n="nav.knowledge" data-capability="patterns">Knowledge</a>
    </div>

    <!-- User Account Menu -->
    <div id="userAccountMenu" style="display: flex; align-items: center; position: relative;">
        <button id="userMenuButton" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <span id="userDisplayName">Loading...</span>
            <span style="font-size: 0.7rem;">â–¼</span>
        </button>

        <div id="userDropdown" style="display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; z-index: 1000;">
            <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                <div style="font-weight: 600; color: #1e293b;" id="dropdownUserName">User</div>
                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;" id="dropdownUserEmail">email@example.com</div>
            </div>

            <!-- Switch Tenant Section -->
            <div id="tenantSwitcherSection" style="padding: 0.75rem 0.5rem; border-bottom: 1px solid #e2e8f0; display: none;">
                <div style="padding: 0 0.5rem 0.5rem; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;" data-i18n="nav.switchTenant">
                    Switch Tenant
                </div>
                <div id="tenantsList"></div>
            </div>

            <!-- Language Selection Section -->
            <div style="padding: 0.75rem 0.5rem; border-bottom: 1px solid #e2e8f0;">
                <div style="padding: 0 0.5rem 0.5rem; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;" data-i18n="nav.language">
                    Language
                </div>
                <button class="language-option" data-lang="en" style="width: 100%; text-align: left; background: transparent; border: none; padding: 0.75rem 1rem; cursor: pointer; border-radius: 6px; transition: background 0.2s; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; color: #475569;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                    <span>ðŸ‡ºðŸ‡¸</span>
                    <span>English</span>
                </button>
                <button class="language-option" data-lang="pt" style="width: 100%; text-align: left; background: transparent; border: none; padding: 0.75rem 1rem; cursor: pointer; border-radius: 6px; transition: background 0.2s; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; color: #475569;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                    <span>ðŸ‡§ðŸ‡·</span>
                    <span>Portugues (BR)</span>
                </button>
                <button class="language-option" data-lang="es" style="width: 100%; text-align: left; background: transparent; border: none; padding: 0.75rem 1rem; cursor: pointer; border-radius: 6px; transition: background 0.2s; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; color: #475569;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                    <span>ðŸ‡ªðŸ‡¸</span>
                    <span>Espanol</span>
                </button>
            </div>

            <div style="padding: 0.5rem;">
                <a href="/auth/profile" style="display: block; padding: 0.75rem 1rem; color: #475569; text-decoration: none; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'" data-i18n="nav.accountSettings">
                    Account Settings
                </a>
                <a href="/users" style="display: block; padding: 0.75rem 1rem; color: #475569; text-decoration: none; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'" data-i18n="nav.manageUsers">
                    Manage Users
                </a>
                <button id="createTenantButton" style="width: 100%; text-align: left; background: transparent; border: none; padding: 0.75rem 1rem; color: #3b82f6; cursor: pointer; border-radius: 6px; transition: background 0.2s; font-size: 1rem; font-weight: 600; border-top: 1px solid #e2e8f0; margin-top: 0.5rem;" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='transparent'" data-i18n="nav.createTenant">
                    + Create New Tenant
                </button>
                <button id="logoutButton" style="width: 100%; text-align: left; background: transparent; border: none; padding: 0.75rem 1rem; color: #dc2626; cursor: pointer; border-radius: 6px; transition: background 0.2s; font-size: 1rem; border-top: 1px solid #e2e8f0; margin-top: 0.5rem;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='transparent'" data-i18n="nav.signOut">
                    Sign Out
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

<!-- Navigation JavaScript -->
<script>
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        // Safety: Remove any stuck menu-open class on page load
        document.body.classList.remove('menu-open');

        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const navLinks = document.getElementById('navLinks');
        const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');

        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', function() {
                this.classList.toggle('active');
                navLinks.classList.toggle('mobile-active');
                mobileMenuOverlay.classList.toggle('active');
                document.body.classList.toggle('menu-open');
            });
        }

        if (mobileMenuOverlay) {
            mobileMenuOverlay.addEventListener('click', function() {
                mobileMenuToggle.classList.remove('active');
                navLinks.classList.remove('mobile-active');
                this.classList.remove('active');
                document.body.classList.remove('menu-open');
            });
        }

        // Close mobile menu when clicking on a link
        const navLinkElements = document.querySelectorAll('.nav-links .nav-link');
        navLinkElements.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    mobileMenuToggle.classList.remove('active');
                    navLinks.classList.remove('mobile-active');
                    mobileMenuOverlay.classList.remove('active');
                    document.body.classList.remove('menu-open');
                }
            });
        });

        // Language selector functionality (within user dropdown)
        const languageOptions = document.querySelectorAll('.language-option');

        languageOptions.forEach(option => {
            option.addEventListener('click', async function(e) {
                e.stopPropagation();
                const lang = this.getAttribute('data-lang');

                if (window.i18n) {
                    await window.i18n.setLanguage(lang);

                    try {
                        await fetch('/api/user/language', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ language: lang })
                        });
                    } catch (error) {
                        console.error('Failed to save language preference:', error);
                    }
                }
            });
        });

        // Progressive disclosure - check capabilities and update nav links
        applyProgressiveDisclosure();
    });

    // Fetch capabilities and apply progressive disclosure to nav links
    async function applyProgressiveDisclosure() {
        try {
            const auth = window.auth;
            if (!auth || !auth.currentUser) {
                // Not authenticated yet, wait for Firebase
                setTimeout(applyProgressiveDisclosure, 1000);
                return;
            }

            const idToken = await auth.currentUser.getIdToken();
            const response = await fetch('/api/onboarding/capabilities', {
                headers: { 'Authorization': `Bearer ${idToken}` }
            });

            if (!response.ok) {
                console.warn('[ProgressiveDisclosure] Failed to fetch capabilities');
                return;
            }

            const data = await response.json();
            if (!data.success) return;

            const capabilities = data.capabilities || {};
            const nextSteps = data.next_steps || [];

            // Store globally for other scripts to access
            window.tenantCapabilities = capabilities;
            window.tenantNextSteps = nextSteps;

            // Apply to nav links
            const navLinks = document.querySelectorAll('[data-capability]');
            navLinks.forEach(link => {
                const requiredCapability = link.getAttribute('data-capability');
                const hasCapability = capabilities[requiredCapability];

                if (!hasCapability) {
                    // Find the relevant next step for tooltip
                    const relevantStep = nextSteps.find(step => {
                        const capMap = {
                            'profile': 'entities',
                            'entities': 'transactions',
                            'transactions': 'analytics',
                            'accounts': 'accounts'
                        };
                        return capMap[step.milestone] === requiredCapability ||
                               step.milestone === requiredCapability;
                    });

                    // Style as disabled
                    link.style.opacity = '0.5';
                    link.style.pointerEvents = 'none';
                    link.style.position = 'relative';

                    // Add lock icon
                    if (!link.querySelector('.lock-icon')) {
                        const lockIcon = document.createElement('span');
                        lockIcon.className = 'lock-icon';
                        lockIcon.textContent = ' ';
                        lockIcon.style.fontSize = '0.7em';
                        link.appendChild(lockIcon);
                    }

                    // Add tooltip
                    if (relevantStep) {
                        link.title = relevantStep.message;
                    } else {
                        link.title = 'Complete setup to unlock this feature';
                    }
                }
            });

            console.log('[ProgressiveDisclosure] Applied capabilities:', capabilities);
        } catch (error) {
            console.warn('[ProgressiveDisclosure] Error:', error);
        }
    }
</script>
