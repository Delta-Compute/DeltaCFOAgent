<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta CFO Agent - Files</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_advanced.css') }}">
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="top-nav">
            <div class="nav-brand">
                <h2>üöÄ Delta CFO Agent</h2>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">Delta's proprietary self improving AI CFO Agent</p>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">üè† Home</a>
                <a href="/dashboard" class="nav-link">üí∏ Expenses</a>
                <a href="/revenue" class="nav-link">üí∞ Revenue Recognition</a>
                <a href="/files" class="nav-link active">üìÇ File Manager</a>
                <a href="/api/stats" class="nav-link">üìà API</a>
            </div>
        </nav>

        <div class="main-layout">
            <div class="dashboard-content">
                <header>
                    <h1>üìÅ File Management</h1>
                </header>

                <!-- Upload Section -->
                <div class="filter-section">
                    <h2>üì§ Upload New CSV Files</h2>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon">üìÅ</div>
                            <h3>Drag & Drop CSV Files Here</h3>
                            <p>Or click to select files</p>
                            <input type="file" id="fileInput" multiple accept=".csv" style="display: none;">
                            <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                                Choose Files
                            </button>
                        </div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">Processing...</div>
                        </div>
                    </div>
                </div>

                <!-- Files Section -->
                <div class="table-section">
                    <div class="table-header">
                        <h2>üìã CSV Files</h2>
                        <div class="table-info">
                            <span>{{ files|length }} files found</span>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in files %}
                                <tr>
                                    <td>{{ file.name }}</td>
                                    <td>{{ "%.1f"|format(file.size / 1024) }} KB</td>
                                    <td>{{ file.modified }}</td>
                                    <td>
                                        <button class="btn-secondary btn-sm" onclick="viewFile('{{ file.name }}')">
                                            View
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        // Handle dropped files
        uploadArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            [...files].forEach(uploadFile);
        }

        async function uploadFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showToast('Only CSV files are allowed', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showProgress();
                updateProgress(0, 'Uploading file...');

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(50, 'Processing transactions...');

                const result = await response.json();

                if (result.success) {
                    updateProgress(100, 'Complete!');
                    let message = `Successfully processed ${file.name}`;
                    if (result.skipped_count > 0) {
                        message += ` (${result.skipped_count} duplicates skipped)`;
                    }
                    showToast(message, 'success');

                    // Refresh the page to show new files
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else if (result.duplicate_confirmation_needed) {
                    // Handle duplicate confirmation dialog
                    handleDuplicateConfirmation(file, result.duplicate_info);
                } else {
                    throw new Error(result.error || result.message || 'Upload failed');
                }

            } catch (error) {
                console.error('Upload error:', error);
                showToast('Upload failed: ' + error.message, 'error');
            } finally {
                setTimeout(hideProgress, 2000);
            }
        }

        function showProgress() {
            document.querySelector('.upload-content').style.display = 'none';
            uploadProgress.style.display = 'block';
        }

        function hideProgress() {
            document.querySelector('.upload-content').style.display = 'block';
            uploadProgress.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function handleDuplicateConfirmation(file, duplicateInfo) {
            hideProgress();

            // Create confirmation dialog
            const dialog = document.createElement('div');
            dialog.className = 'duplicate-dialog-overlay';
            dialog.innerHTML = `
                <div class="duplicate-dialog">
                    <h3>üîÑ Duplicate Transactions Found</h3>
                    <p>Found <strong>${duplicateInfo.duplicate_count}</strong> duplicate transactions out of ${duplicateInfo.total_transactions} total.</p>
                    <p style="color: #4a5568; font-size: 0.9rem; margin-bottom: 1rem;">These transactions appear to already exist in your database. How would you like to proceed?</p>

                    <div class="duplicate-preview">
                        <h4>Sample duplicates:</h4>
                        <div class="duplicate-list">
                            ${duplicateInfo.duplicates.map(dup => `
                                <div class="duplicate-item">
                                    <span class="duplicate-date">${dup.date}</span>
                                    <span class="duplicate-desc">${dup.description}</span>
                                    <span class="duplicate-amount">$${dup.amount}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="dialog-buttons">
                        <button class="btn-secondary" onclick="closeDuplicateDialog()">Cancel Upload</button>
                        <button class="btn-primary" onclick="processDuplicates('${file.name}', 'keep')">Skip Duplicates</button>
                        <button class="btn-primary" onclick="processDuplicates('${file.name}', 'overwrite')">Update with New Data</button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
        }

        function closeDuplicateDialog() {
            const dialog = document.querySelector('.duplicate-dialog-overlay');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }

        async function processDuplicates(filename, action) {
            closeDuplicateDialog();

            try {
                showProgress();
                updateProgress(0, `Processing with ${action} mode...`);

                const formData = new FormData();
                formData.append('duplicateHandling', action);
                formData.append('filename', filename);

                const response = await fetch('/api/process-duplicates', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    updateProgress(100, 'Complete!');
                    showToast(result.message || 'Processing completed', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Processing failed');
                }

            } catch (error) {
                console.error('Processing error:', error);
                showToast('Processing failed: ' + error.message, 'error');
            } finally {
                setTimeout(hideProgress, 2000);
            }
        }

        function viewFile(filename) {
            // Open file details or download
            window.open(`/api/download/${filename}`, '_blank');
        }

        function showToast(message, type = 'success') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid ${type === 'error' ? '#e53e3e' : '#38a169'};
                z-index: 1000;
                max-width: 300px;
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                document.body.removeChild(toast);
            }, 5000);
        }
    </script>

    <style>
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #ebf8ff;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-content h3 {
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .upload-content p {
            color: #718096;
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            color: #4a5568;
            font-weight: 500;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }


        .duplicate-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .duplicate-dialog {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .duplicate-dialog h3 {
            margin: 0 0 1rem 0;
            color: #2d3748;
        }

        .duplicate-preview {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .duplicate-preview h4 {
            margin: 0 0 1rem 0;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .duplicate-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .duplicate-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .duplicate-date {
            color: #667eea;
            font-weight: 500;
        }

        .duplicate-desc {
            color: #4a5568;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .duplicate-amount {
            color: #38a169;
            font-weight: 500;
        }

        .dialog-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
    </style>
</body>
</html>