<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta CFO Agent - Advanced Transaction Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_advanced.css') }}?v={{ cache_buster }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="top-nav">
            <div class="nav-brand">
                <h2>Delta CFO Agent</h2>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">Delta's proprietary self improving AI CFO Agent</p>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/dashboard" class="nav-link active">Expenses</a>
                <a href="/revenue" class="nav-link">Revenue Recognition</a>
                <a href="/invoices" class="nav-link">Invoices</a>
                <a href="/files" class="nav-link">File Manager</a>
                <a href="/api/stats" class="nav-link">API</a>
            </div>
        </nav>

        <div class="main-layout">
            <div class="dashboard-content">
                <header>
                    <h1>Advanced Transaction Dashboard</h1>
                    <div class="stats-summary">
                        <div class="stat-card">
                            <h3>Total Transactions</h3>
                            <div class="stat-number">{{ stats.total_transactions }}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <div class="stat-number positive">${{ "%.2f"|format(stats.total_revenue) }}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Expenses</h3>
                            <div class="stat-number negative">${{ "%.2f"|format(stats.total_expenses) }}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Needs Review</h3>
                            <div class="stat-number warning">{{ stats.needs_review }}</div>
                        </div>
                    </div>
                    <div class="date-range">
                        üìÖ Data Range: {{ stats.date_range.min }} to {{ stats.date_range.max }}
                    </div>
                </header>

        <!-- Filter Controls -->
        <div class="filter-section">
            <h2>üîç Advanced Filters</h2>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="entityFilter">Business Entity:</label>
                    <select id="entityFilter">
                        <option value="">All Entities</option>
                        {% for entity, count in stats.entities %}
                        <option value="{{ entity }}">{{ entity }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="transactionType">Transaction Type:</label>
                    <select id="transactionType">
                        <option value="">All Types</option>
                        <option value="Revenue">Revenue Only</option>
                        <option value="Expense">Expenses Only</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sourceFile">Source File:</label>
                    <select id="sourceFile">
                        <option value="">All Sources</option>
                        {% for source, count in stats.source_files %}
                        <option value="{{ source }}">{{ source|truncate(30) }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="needsReview">Review Status:</label>
                    <select id="needsReview">
                        <option value="">All Transactions</option>
                        <option value="true">Needs Review Only</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="minAmount">Min Amount ($):</label>
                    <input type="number" id="minAmount" step="0.01" placeholder="0.00">
                </div>

                <div class="filter-group">
                    <label for="maxAmount">Max Amount ($):</label>
                    <input type="number" id="maxAmount" step="0.01" placeholder="No limit">
                </div>

                <div class="filter-group">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate">
                </div>

                <div class="filter-group">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate">
                </div>

                <div class="filter-group">
                    <label for="keywordFilter">Keyword Search:</label>
                    <input type="text" id="keywordFilter" placeholder="Search transaction descriptions...">
                </div>
            </div>

            <div class="quick-filters">
                <h3>üîç Quick Filters:</h3>
                <button id="filterTodos" class="btn-quick todo-filter">üìù To Do's Only</button>
                <button id="filter2025" class="btn-quick">2025 Full Year</button>
                <button id="filter2024" class="btn-quick">2024 Full Year</button>
                <button id="filterYTD" class="btn-quick">2025 YTD</button>
            </div>

            <button id="applyFilters" class="btn-primary">Apply Filters</button>
            <button id="clearFilters" class="btn-secondary">Clear All</button>
        </div>

        <!-- Transaction Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>üìã Advanced Transaction Management</h2>
                <div class="table-info">
                    <span id="tableInfo">Loading...</span>
                    <button id="refreshData" class="btn-secondary">üîÑ Refresh</button>
                    <button id="exportCSV" class="btn-secondary">üì• Export CSV</button>
                </div>
            </div>

            <div class="table-container">
                <table id="transactionTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="date">Date ‚Üï</th>
                            <th class="sortable" data-sort="origin">Origin ‚Üï</th>
                            <th class="sortable" data-sort="destination">Destination ‚Üï</th>
                            <th class="sortable" data-sort="description">Description ‚Üï</th>
                            <th class="sortable" data-sort="amount">Amount ‚Üï</th>
                            <th>Crypto</th>
                            <th class="sortable" data-sort="classified_entity">Entity ‚Üï</th>
                            <th class="sortable" data-sort="accounting_category">Accounting Category ‚Üï</th>
                            <th>Justification</th>
                            <th class="sortable" data-sort="confidence">Confidence ‚Üï</th>
                            <th class="sortable" data-sort="source_file">Source ‚Üï</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <tr>
                            <td colspan="12" class="loading">Loading transactions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination">
                    <button id="prevPage" class="btn-pagination" disabled>‚Üê Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextPage" class="btn-pagination" disabled>Next ‚Üí</button>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- AI Suggestions Modal -->
    <div id="suggestionsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ AI Suggestions</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="suggestionsContent">
                    <!-- Dynamically populated -->
                </div>
                <div id="suggestionsList">
                    <div class="loading">Loading suggestions...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="{{ url_for('static', filename='script_advanced.js') }}?v={{ cache_buster }}"></script>
</body>
</html>